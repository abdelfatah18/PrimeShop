{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="container my-5">
  <div class="text-center mb-5">
    <h1 class="fw-bold display-6 mb-3">üõçÔ∏è Discover Our Collection</h1>
    <p class="text-muted fs-5">High-quality products curated just for you</p>
  </div>

  <!-- ŸÅŸÑÿßÿ™ÿ± Ÿàÿ™ÿµŸÜŸäŸÅÿßÿ™ -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="d-flex align-items-center">
      <span class="me-3 fw-medium">Filter by:</span>

      <div class="btn-group btn-group-sm" role="group">
        <a href="?filter=all" class="btn btn-outline-dark {% if filter == 'all' %}active{% endif %}">All</a>
        <a href="?filter=popular" class="btn btn-outline-dark {% if filter == 'popular' %}active{% endif %}">Popular</a>
        <a href="?filter=new" class="btn btn-outline-dark {% if filter == 'new' %}active{% endif %}">New</a>
        <a href="?filter=sale" class="btn btn-outline-dark {% if filter == 'sale' %}active{% endif %}">Sale</a>
      </div>
    </div>
  </div>

  <div class="col-md-6 text-md-end mt-2 mt-md-0">
    <div class="d-inline-flex align-items-center">
      <span class="me-3 fw-medium">Sort by:</span>

      <form method="get">
        <input type="hidden" name="filter" value="{{ filter }}">
        <select name="sort" class="form-select form-select-sm w-auto border-dark" onchange="this.form.submit()">
          <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
          <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
          <option value="name" {% if sort == 'name' %}selected{% endif %}>Name A-Z</option>
          <option value="newest" {% if sort == 'newest' %}selected{% endif %}>Newest First</option>
        </select>
      </form>

    </div>
  </div>
</div>


  <!-- ÿ¥ÿ®ŸÉÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ -->
  <div class="row g-4">
    {% for product in products %}
      <div class="col-6 col-md-4 col-lg-3">
        <div class="card product-card h-100 border-0 rounded-4 overflow-hidden shadow-sm position-relative">
          <!-- ÿπŸÑÿßŸÖÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ -->
          {% if product.is_new %}
            <span class="position-absolute top-0 start-0 m-3 badge bg-danger">NEW</span>
          {% elif product.discount_price %}
            <span class="position-absolute top-0 start-0 m-3 badge bg-success">SALE</span>
          {% endif %}
          
          <!-- ÿ≤ÿ± ÿßŸÑŸÇŸÑÿ® ŸÑŸÑŸÖŸÅÿ∂ŸÑÿ© -->
          <button
            class="btn btn-light position-absolute top-0 end-0 m-3 p-2 rounded-circle favorite-btn {% if product.is_in_wishlist %}active{% endif %}"
            data-product-id="{{ product.id }}"
            data-initial-state="{% if product.is_in_wishlist %}liked{% else %}unliked{% endif %}"
          >
            <i class="{% if product.is_in_wishlist %}fas text-danger{% else %}far{% endif %} fa-heart"></i>
          </button>

          <!-- ÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ -->
          <a href="{% url 'product_detail' product.slug %}" class="text-decoration-none">
            <div class="product-image-container position-relative overflow-hidden bg-light">
              {% if product.image %}
                <img src="{{ product.image.url }}" 
                     class="product-img w-100" 
                     alt="{{ product.name }}"
                     loading="lazy">
              {% else %}
                <img src="{% static 'images/placeholder.png' %}" 
                     class="product-img w-100" 
                     alt="No image"
                     loading="lazy">
              {% endif %}
              <div class="product-overlay position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center">
                <span class="btn btn-dark btn-lg rounded-pill px-4 py-2">Quick View</span>
              </div>
            </div>
          </a>
          
          <!-- ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© -->
          <div class="card-body p-3">
            <!-- ÿßŸÑŸÅÿ¶ÿ© -->
            {% if product.category %}
              <p class="text-muted small mb-1">{{ product.category.name }}</p>
            {% endif %}
            
            <!-- ÿßŸÑÿßÿ≥ŸÖ -->
            <a href="{% url 'product_detail' product.slug %}" class="text-decoration-none text-dark">
              <h6 class="card-title fw-semibold mb-2 product-title">{{ product.name }}</h6>
            </a>
            
            <!-- ÿßŸÑÿ™ŸÇŸäŸäŸÖ -->
            <div class="mb-2">
              <span class="text-warning">
                {% for _ in ""|center:product.full_stars %}
                  <i class="fas fa-star"></i>
                {% endfor %}
                {% if product.half_star %}
                  <i class="fas fa-star-half-alt"></i>
                {% endif %}
                {% for _ in ""|center:product.empty_stars %}
                  <i class="far fa-star"></i>
                {% endfor %}
              </span>
              <span class="text-muted small ms-1">({{ product.review_count }})</span>
            </div>
            
            <!-- ÿßŸÑÿ≥ÿπÿ± -->
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <span class="fw-bold fs-5 text-dark">${{ product.display_price|safe }}</span>
                {% if product.original_price and product.original_price != product.price %}
                  <span class="text-muted text-decoration-line-through ms-2">${{ product.original_price }}</span>
                {% endif %}
              </div>
            </div>
            
            <!-- ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± -->
<form class="add-to-cart-form mb-0" data-url="{% url 'add_to_cart' product.slug %}">
  {% csrf_token %}
  <button type="submit" class="btn btn-dark w-100 rounded-pill py-2">
    <i class="fas fa-shopping-cart me-2"></i>Add to Cart
  </button>

  
</form>



          </div>
        </div>
      </div>
    {% empty %}
      <div class="col-12 text-center py-5">
        <div class="mb-4">
          <i class="fas fa-box-open text-muted" style="font-size: 4rem;"></i>
        </div>
        <h4 class="text-muted mb-3">No Products Available</h4>
        <p class="text-muted">Check back soon for new arrivals!</p>
        <a href="/" class="btn btn-dark rounded-pill px-4">Continue Shopping</a>
      </div>
    {% endfor %}
  </div>
  
  <!-- ÿ™ÿ±ŸÇŸäŸÖ ÿßŸÑÿµŸÅÿ≠ÿßÿ™ -->
  {% if products.has_other_pages %}
    <nav class="mt-5" aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        {% if products.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ products.previous_page_number }}">Previous</a>
          </li>
        {% endif %}
        
        {% for num in products.paginator.page_range %}
          <li class="page-item {% if products.number == num %}active{% endif %}">
            <a class="page-link" href="?page={{ num }}">{{ num }}</a>
          </li>
        {% endfor %}
        
        {% if products.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ products.next_page_number }}">Next</a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}
</div>

<style>
/* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ÿßŸÑŸÇŸÑŸàÿ® */
.favorite-btn.active {
  background: rgba(220, 53, 69, 0.1) !important;
  border-color: rgba(220, 53, 69, 0.3) !important;
}

.favorite-btn.active i {
  color: #dc3545 !important;
}

.favorite-btn:hover:not(.active) i {
  color: #dc3545 !important;
}

/* ÿ£ŸÜŸäŸÖŸäÿ¥ŸÜ ŸÑŸÑŸÇŸÑÿ® */
@keyframes heartBeat {
  0% { transform: scale(1); }
  25% { transform: scale(1.2); }
  50% { transform: scale(1); }
  75% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.heart-animation {
  animation: heartBeat 0.6s ease;
}

/* ÿ®ÿßŸÇŸä ÿßŸÑÿ£ŸÜŸÖÿßÿ∑ ÿ™ÿ®ŸÇŸâ ŸÉŸÖÿß ŸáŸä */
.product-card {
  transition: all 0.3s ease;
  background: #fff;
}

.product-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
}

.product-image-container {
  height: 300px;
  position: relative;
  overflow: hidden;
}

.product-img {
  height: 100%;
  object-fit: contain;
  padding: 20px;
  transition: transform 0.5s ease;
  opacity: 1 !important;
}

.product-card:hover .product-img {
  transform: scale(1.08);
}

.product-overlay {
  background: rgba(0, 0, 0, 0.7);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.product-card:hover .product-overlay {
  opacity: 1;
}

.favorite-btn {
  width: 36px;
  height: 36px;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(5px);
  transition: all 0.2s ease;
  z-index: 2;
}

@media (max-width: 768px) {
  .product-image-container {
    height: 180px;
  }
  
  .card-body {
    padding: 1rem !important;
  }
}
</style>

<!-- ÿ•ÿ∂ÿßŸÅÿ© Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.favorite-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();

      const productId = this.dataset.productId;
      const icon = this.querySelector('i');
      const button = this;
      
      // ÿ•ÿ∂ÿßŸÅÿ© ÿ£ŸÜŸäŸÖŸäÿ¥ŸÜ
      icon.classList.add('heart-animation');
      setTimeout(() => icon.classList.remove('heart-animation'), 600);

      // ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ® AJAX
      fetch("{% url 'toggle_wishlist' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: `product_id=${productId}`
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "added") {
          // ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©
          icon.classList.remove("far");
          icon.classList.add("fas", "text-danger");
          button.classList.add("active");
          button.dataset.initialState = "liked";
          
          // ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿ¨ÿßÿ≠ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
          showToast("Product added to wishlist!", "success");
          
        } else if (data.status === "removed") {
          // ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿ≤ÿßŸÑÿ©
          icon.classList.remove("fas", "text-danger");
          icon.classList.add("far");
          button.classList.remove("active");
          button.dataset.initialState = "unliked";
          
          // ÿ±ÿ≥ÿßŸÑÿ© ŸÜÿ¨ÿßÿ≠ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
          showToast("Product removed from wishlist!", "info");
          
        } else if (data.status === "login_required") {
          // ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÖÿ≥ÿ¨ŸÑ ÿØÿÆŸàŸÑ
          window.location.href = "{% url 'login' %}?next={{ request.path }}";
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showToast("An error occurred. Please try again.", "danger");
      });
    });
  });

  // ÿØÿßŸÑÿ© ŸÑÿπÿ±ÿ∂ ÿ±ÿ≥ÿßÿ¶ŸÑ ÿßŸÑÿ™ŸÜÿ®ŸäŸá (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)
  function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0 position-fixed bottom-0 end-0 m-3`;
    toast.setAttribute('role', 'alert');
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;
    document.body.appendChild(toast);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    setTimeout(() => toast.remove(), 3000);
  }
});

document.querySelectorAll('.add-to-cart-form').forEach(form => {
  form.addEventListener('submit', function (e) {
    e.preventDefault();

    const url = this.dataset.url;
    const csrfToken = this.querySelector('[name=csrfmiddlewaretoken]').value;
    const button = this.querySelector('button');

    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest',
      },
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        button.innerHTML = ' Added';
        button.classList.remove('btn-dark');
        button.classList.add('btn-success');

        // ÿ™ÿ≠ÿØŸäÿ´ ÿπÿØÿßÿØ ÿßŸÑŸÉÿßÿ±ÿ™ (ŸÑŸà ÿπŸÜÿØŸÉ)
        const cartBadge = document.querySelector('.cart-count');
        if (cartBadge) {
          cartBadge.textContent = data.cart_count;
        }
      }
    })
    .catch(error => console.error(error));
  });
});
</script>

{% endblock %}

